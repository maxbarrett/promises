<html>
<head>
	<title>Promises</title>
	<link rel="stylesheet" type="text/css" href="http://necolas.github.io/normalize.css/latest/normalize.css">
	<style>
		body { padding:0 20px; }
		button { margin:20px 0 0; }
	</style>
</head>

<body>

	<h1>Promises</h1>

	<p>TODO: explain...</p>

	<button id="ex1">1) Get chapters</button>
	<div id="output1"></div>

	<button id="ex2">2) Get chapters</button>
	<div id="output2"></div>

	<button id="ex3">3) Get chapters</button>
	<div id="output3"></div>

	<button id="ex4">4) Get chapters</button>
	<div id="output4"></div>

	<button id="ex5">5) Get chapters</button>
	<div id="output5"></div>


	<script id="utilities">
		function $(el){
			return document.querySelector(el);
		}

		function get(url){
			// Return a new promise.
			return new Promise(function(resolve, reject){

				// Do the usual XHR stuff
				var req = new XMLHttpRequest();
				req.open('GET', url);

				req.onload = function(){
					if (req.status == 200){
						// Resolve the promise with the response text
						resolve(req.response);
					} else {
						// Otherwise reject with the status text
						reject(Error(req.statusText));
					}
				}

				// Handle network errors
				req.onerror = function(){
					reject(Error('Network error'));
				}

				// Make the request
				req.send();
			});
		}

		function getJSON(url){
			//When you return a value from a "then" callback the next "then" is called with that value. 
			// If you return a promise the next "then" waits, called only when that promise succeeds/fails.
			return get(url).then(JSON.parse).catch(function(error){
				console.log('Failed on url: ', url, ' for: ', error);
				throw error;
			});
		}

		// #2) Utility function to retrieve a chapter:
		var storyPromise;
		function getChapter(i){
			// Download "story.json" once, then reuse the promise 
			storyPromise = storyPromise || getJSON('story.json');
			return storyPromise.then(function(story){
				return getJSON(story.chapterUrls[i]);
			})
		}

		function addTextToPage(content, dest) {
			var p = document.createElement('p');
			p.textContent = content;
			$(dest).appendChild(p);
		}
	</script>


	<script id="example1">
		$('#ex1').addEventListener('click', function(e){
			// #1) Make AJAX call to get first chapter, then add it to the dom:
			getJSON('story.json').then(function(story){
				return getJSON(story.chapterUrls[0]);
			}).then(function(chapter1){
				addTextToPage(chapter1.html, '#output1');
			});
		});
	</script>


	<script id="example2">
		$('#ex2').addEventListener('click', function(e){
			// #2) Get first, then second chapters...
			getChapter(0).then(function(chapter){
				addTextToPage(chapter.html, '#output2');
				return getChapter(1);
			}).then(function(chapter){
				addTextToPage(chapter.html, '#output2');
			}).catch(function(error){
				addTextToPage('Failed to load chapter: ' + error, '#output2');
			});
		});
	</script>


	<script id="example3">
		// #3)
		$('#ex3').addEventListener('click', function(e){
			getJSON('story.json').then(function(story){
			    return story.chapterUrls.reduce(function(sequence, chapterUrl){
			        return sequence.then(function(){
			            return getJSON(chapterUrl);
			        }).then(function(chapter){
			        	addTextToPage(chapter.html, '#output3');
			        });
			    }, Promise.resolve());
			}).then(function(){
				addTextToPage('All done!', '#output3');
			}).catch(function(error){
				addTextToPage('Error: ' + error, '#output3');
			});
		});
	</script>


	<script id="example4">
		// #4)
		$('#ex4').addEventListener('click', function(e){
			getJSON('story.json').then(function(story){
			    return Promise.all(
			        story.chapterUrls.map(getJSON)
			    );
			}).then(function(chapters){
			    chapters.forEach(function(chapter){
			    	addTextToPage(chapter.html, '#output4');
			    });
			    addTextToPage('All done!', '#output4');
			}).catch(function(error){
				addTextToPage('Error: ' + error, '#output4');
			});
		});
	</script>


	<script id="example5">
		// #5)
		$('#ex5').addEventListener('click', function(e){
			getJSON('story.json').then(function(story){
			    return story.chapterUrls.map(getJSON)
			        .reduce(function(sequence, chapterPromise){
			                return sequence.then(function(){
			                    return chapterPromise;
			            }).then(function(chapter){
			            	addTextToPage(chapter.html, '#output5');
			            });
			        }, Promise.resolve());
			}).then(function(){
			    addTextToPage('All done!', '#output5');
			}).catch(function(error){
			     addTextToPage('Error: ' + error, '#output5');
			});
		});
	</script>

</body>
</html>